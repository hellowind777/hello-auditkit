# 渐进加载审计规则

> **适用于**：技能、插件、复合系统
> **执行要求**：审计每个层级（L1-L4）的内容放置。检查反模式。验证"何时读取"指导。

## 目录

- [概述](#概述)
- [加载层级模型](#加载层级模型)
- [内容放置审计](#内容放置审计)
- [渐进披露](#渐进披露)
- [参考文件审计](#参考文件审计)
- [反模式](#反模式)
- [输出格式](#输出格式)

---

## 概述

### 两个相关概念

| 概念 | 定义 | 目标 |
|------|------|------|
| **渐进加载** | 分阶段加载内容 | 最小化上下文使用 |
| **渐进披露** | 逐步揭示信息 | 减少认知负荷 |

---

## 加载层级模型

### 标准层级

| 层级 | 内容 | 加载时机 | 成本 | 限制 |
|------|------|----------|------|------|
| **L1** | 元数据 | 始终 | 永久 | ~100 词 |
| **L2** | 主正文 | 触发时 | 会话 | <500 行 |
| **L3** | 参考文件 | 按需 | 临时 | **无官方限制** |
| **L4** | 脚本 | 仅运行时 | 零 | 无限制 |

### L1：元数据（始终加载）

**必须在 L1 的内容：**
- 唯一标识符（name）
- 触发条件（description）
- 基本路由关键词

**不应在 L1 的内容：**
- 实现细节
- 完整指令
- >1 句的示例

### L2：主正文（触发加载）

**应包含的内容：**
- 核心指令和工作流
- 常见情况处理
- 主要输出格式
- 简短内联示例

**应移到 L3 的内容：**
- 详细表格（>20 行）
- 扩展示例（>10 行）
- 领域特定文档
- 边缘情况详情
- 历史背景

### L3：参考文件（按需）

**应包含的内容：**
- 详细规范
- 全面示例
- 领域知识
- API 文档
- 查询表

**不应在此的内容：**
- 核心工作流（每次都需要）
- 关键约束
- 主要输出格式

### L4：脚本（仅运行时）

- 从不加载到 AI 上下文
- 运行时执行
- **无尺寸限制**

---

## 内容放置审计

### 步骤 1：按层级清点

```markdown
## 内容层级清点

| 层级 | 位置 | 内容 | 行数 |
|------|------|------|------|
| L1 | frontmatter | name, desc | X |
| L2 | SKILL.md 正文 | [章节] | Y |
| L3 | references/*.md | [文件] | Z |
| L4 | scripts/*.py | [脚本] | W |
```

### 步骤 2：识别放置错误

<content_placement_analysis>
内容放置判断需要分析：
- L1 膨胀：description 是否 >500 字符？是否包含工作流/代码？
- L2 过载：正文是否 >500 行？是否有可分离的大表格/示例？
- L3 误用：核心工作流是否在 L3？是否缺少"何时读取"指导？
- 关键问题：此内容是每次都需要还是按需加载？
</content_placement_analysis>

#### L1 膨胀检测

| 问题 | 检测 | 严重性 |
|------|------|--------|
| Description >500 字符 | 字符计数 | Warning |
| Description 含实现 | 包含工作流 | Warning |
| Description 含示例 | 代码块 | Warning |
| 冗余关键词 | 重复概念 | Info |

#### L2 过载检测

| 问题 | 检测 | 严重性 |
|------|------|--------|
| 正文 >500 行 | 行计数 | Warning（>625：Severe）|
| 大型内联表格 | >20 行 | Warning |
| 扩展示例 | 每个 >10 行 | Info |
| 仅边缘情况内容 | 条件使用 | Warning |
| 与 L3 重复 | 相同内容 | Warning |

#### L3 误用检测

| 问题 | 检测 | 严重性 |
|------|------|--------|
| 核心工作流在 L3 | 应在 L2 | Severe |
| 无"何时读取" | 缺少指导 | Warning |
| 参考从不需要 | 无使用场景 | Info |
| 参考始终需要 | 应在 L2 | Warning |

### 步骤 3：计算效率

```markdown
## 加载效率

| 指标 | 值 | 目标 | 状态 |
|------|-----|------|------|
| L1 尺寸 | X 词 | ≤100 | ✅/⚠️/❌ |
| L2 尺寸 | Y 行 | ≤500 | ✅/⚠️/❌ |
| L3 尺寸 | Z 行 | 按内容评估 | ✅/⚠️ |
| L3 中"始终需要"| N 个文件 | 0 | ⚠️ 如 >0 |
```

---

## 渐进披露

### 披露层次

| 层次 | 用户看到什么 | 何时 |
|------|--------------|------|
| **表面** | 基本用法 | 首次交互 |
| **标准** | 完整功能 | 常规使用 |
| **高级** | 边缘情况、配置 | 专家使用 |

### 表面层检查

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 简单用法有效 | 合理默认值 | Severe |
| 提供基本示例 | 内容早期 | Warning |
| 无强制复杂设置 | 可立即开始 | Warning |

### 标准层检查

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 选项有文档 | 所有可配置行为 | Warning |
| 选项有默认值 | 无强制决策 | Info |
| 覆盖常见工作流 | 80% 用例在正文中 | Warning |

### 高级层检查

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 高级内容分离 | 在参考文件或标记 | Info |
| 专家选项有文档 | 用于定制 | Info |
| 边缘情况在参考文件 | 不杂乱主正文 | Info |

---

## 参考文件审计

### "何时读取"要求

每个参考文件必须在 SKILL.md 中有加载指导：

**好：**
```markdown
## 参考文件

在以下情况读取 `references/api-spec.md`：
- 用户询问 API 端点
- 生成 API 代码
- 调试 API 错误
```

**差：**
```markdown
更多信息见 references/。
```

### 参考文件检查清单

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 有"何时读取" | 在 SKILL.md 中 | Warning |
| 条件具体 | 不只是"需要时" | Info |
| 条件可检测 | AI 可识别 | Warning |
| 不总是需要 | 应在 L2 | Warning |
| 不从不需要 | 删除或说明理由 | Info |

### 加载模式

| 模式 | 描述 | 状态 |
|------|------|------|
| **条件式** | 特定场景加载 | ✅ 正确 |
| **始终** | 每次加载 | ❌ 移到 L2 |
| **从不** | 从不实际使用 | ❌ 删除 |
| **级联** | A 说加载 B | ⚠️ 避免深度 |

---

## 反模式

### 1. 元数据膨胀

```yaml
# 差
description: |
  此技能帮助处理 X。触发时：
  1. 首先分析输入
  2. 按规则处理
  示例：输入"foo"产生"bar"

# 好
description: 当用户要求"做 X"或提及"关键词 Y"时使用。
```

**检测**：Description >300 字符且含工作流/代码

### 2. 单体正文

```markdown
# 差 - 800+ 行 SKILL.md
## 核心（50 行）
## API 参考（200 行）  ← 应在 L3
## 错误码（150 行）    ← 应在 L3
## 示例（100 行）      ← 应在 L3
```

**检测**：正文 >500 行且有可分离章节

### 3. 核心内容在 L3

```markdown
# 差
## 概述
此技能处理数据。工作方式见 `references/workflow.md`。
```

**检测**：主正文缺少工作流；参考始终需要

### 4. 孤立参考

```
references/
├── spec-v1.md      # SKILL.md 未提及
├── old-format.md   # 未提及
└── maybe-useful.md # 未提及
```

**检测**：参考未以"何时读取"提及

### 5. 参考级联

```markdown
# references/main.md
详情见 `sub-spec.md`。

# references/sub-spec.md
实现见 `impl-notes.md`。
```

**检测**：参考有内部交叉引用；深度 >1

### 6. 倒置披露

```markdown
# 差的顺序
## 高级配置   ← 专家优先
## 性能调优
## 基本用法   ← 基础埋底！
```

**检测**："基本/简单"章节在"高级/专家"之后

---

## 输出格式

### 渐进加载章节

```markdown
## 渐进加载分析

### 内容层级分布
| 层级 | 位置 | 尺寸 | 目标 | 状态 |
|------|------|------|------|------|
| L1 | frontmatter | X 词 | ≤100 | ✅/⚠️ |
| L2 | SKILL.md | Y 行 | ≤500 | ✅/⚠️ |
| L3 | references/ | Z 行 | 无官方限制 | ✅/⚠️ |
| L4 | scripts/ | W 行 | 无限制 | ✅ |

### 加载效率
**总体**：[良好/可接受/需优化]

| 指标 | 状态 |
|------|------|
| L1 最小化 | ✅/⚠️ |
| L2 自足性 | ✅/⚠️ |
| L3 条件性 | ✅/⚠️ |
| 披露顺序 | ✅/⚠️ |

### 内容放置问题
| 内容 | 当前 | 建议 | 原因 | 严重性 |
|------|------|------|------|--------|
| [X] | L2 | L3 | 仅边缘情况 | Warning |
| [Y] | L3 | L2 | 每次都需要 | Severe |

### 参考加载指导
| 文件 | 有"何时读取"| 具体 | 状态 |
|------|------------|------|------|
| api-spec.md | ✅ | ✅ | 良好 |
| error-codes.md | ❌ | - | 缺失 |

### 检测到的反模式
| 模式 | 检测到 | 位置 | 严重性 |
|------|--------|------|--------|
| 元数据膨胀 | ✅/❌ | | Warning |
| 单体正文 | ✅/❌ | | Warning |
| 核心在 L3 | ✅/❌ | | Severe |
| 孤立参考 | ✅/❌ | | Warning |

### 建议
1. [优先级 1]：[最有影响]
2. [优先级 2]：[第二修复]
```

---

## 严重性指南

| 问题 | 严重性 |
|------|--------|
| 核心工作流在 L3 | Severe |
| L1 >1000 字符 | Severe |
| L2 >750 行 | Severe |
| L2 >625 行 | Warning |
| L2 >500 行 | Info |
| 无"何时读取" | Warning |
| 参考始终需要 | Warning |
| 参考从不需要 | Info |
| 倒置披露 | Warning |
| 元数据 300-500 字符 | Info |
| 元数据 >500 字符 | Warning |
