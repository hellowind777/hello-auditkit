# 结构完整性审计规则

> **何时读取**：审计包含规则、编号项、层次结构或交叉引用的内容时。
> **另见**：`rules-universal.md` 中的命名/编号/引用完整性基础规则（本文件是其扩展）

## 目录

- [文件结构](#文件结构)
- [规则命名与编号](#规则命名与编号)
- [规则顺序与层次](#规则顺序与层次)
- [重复检测](#重复检测)
- [引用完整性](#引用完整性)
- [规则有效性](#规则有效性)
- [示例与规则一致性](#示例与规则一致性)
- [快速参考](#快速参考)

---

## 文件结构

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 必需文件存在 | 所有声明/预期的文件都存在 | Severe |
| 无孤立文件 | 所有文件被引用或记录 | Warning |
| 无空文件 | 所有文件有实质内容 | Warning |
| 命名模式一致 | 整体使用相同的命名约定 | Warning |
| 目录结构与 TOC 匹配 | 如有 TOC，结构应对齐 | Warning |

---

## 规则命名与编号

> **基础规则**：见 `rules-universal.md` → 命名、编号与顺序规则

### 扩展命名检查

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 相同命名模式 | 所有规则使用相同格式（R1/Rule-1/1.1）| Warning |
| 无跨文件冲突 | 不同文件中相同名称 = 相同含义 | Severe |
| 无跨章节冲突 | 不同章节中相同名称 = 相同含义 | Severe |
| 无保留字遮蔽 | 自定义名称不遮蔽系统术语 | Warning |

**常见冲突模式**：
- 跨文件：两个文件中"output_spec"定义不同
- 保留字遮蔽：自定义"Read"操作 vs 系统"Read"工具

### 扩展编号检查

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 跨章节连续 | 如编号跨章节，则无中断 | Warning |
| 跨章节意识 | A 章节的 1.1 != B 章节的 1.1（如在同一范围）| Severe |
| 一致的重置模式 | 新章节有清晰的重置模式 | Warning |

---

## 规则顺序与层次

### 顺序检查

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 前置条件在前 | 依赖规则在被依赖规则之后 | Warning |
| 通用在前具体在后 | 基础规则在例外之前 | Warning |
| TOC 顺序与内容匹配 | 章节按 TOC 顺序出现 | Warning |
| 标题层次 | H1→H2→H3（不跳级）| Warning |

### 层次检查

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 父子关系正确 | 子规则在正确的父规则下 | Severe |
| 无孤立子项 | 所有子规则有有效的父规则 | Warning |
| 无空父项 | 父章节有子项 | Warning |
| 无跳级 | 1 → 1.1 → 1.1.1，而非 1 → 1.1.1 | Warning |

---

## 重复检测

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 无完全相同的规则 | 相同文本不重复 | Warning |
| 无语义重复 | 不同措辞但相同意图 | Warning |
| 无规则重叠 | 规则不覆盖相同情况 | Warning |

**解决方案**：
- 完全重复 → 删除其中一份
- 语义重复 → 合并为单一规则
- 重叠 → 修改以明确边界

---

## 引用完整性

> **基础规则**：见 `rules-universal.md` → 引用完整性规则

### 扩展引用类型

| 类型 | 模式 | 示例 |
|------|------|------|
| 变量引用 | `{file}`、`{{path}}` | `{config_path}` |
| 隐式文本引用 | `见 xxx`、`参考 xxx` | `见 methodology-core.md` |

### 扩展检查

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 变量引用已定义 | 所有 `{var}` 引用有定义 | Severe |
| 隐式引用存在 | 文本引用（"见 X"）有目标 | Severe |
| 大小写敏感 | 文件名大小写在大小写敏感系统上匹配 | Warning |

### 常见断裂引用模式

| 模式 | 示例 | 严重性 |
|------|------|--------|
| 锚点大小写不匹配 | `#My-Section` vs `## my section` | Severe |
| 未定义的变量 | `{undefined_var}` | Severe |
| 过期的编号引用 | `见 R5`（R5 已删除）| Severe |
| 相对路径错误 | `../wrong/path.md` | Severe |
| 名称拼写错误 | `refrence.md` | Severe |

---

## 规则有效性

### 语法有效性

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 完整句子 | 规则语法完整 | Warning |
| 主体清晰 | 规则适用对象清晰 | Warning |
| 行动清晰 | 做什么/不做什么清晰 | Warning |
| 无截断 | 规则未在句中截断 | Severe |

### 逻辑有效性

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 无矛盾 | 规则不冲突 | Fatal |
| 无不可能条件 | 规则可实现 | Fatal |
| 无循环逻辑 | 规则不产生循环 | Fatal |
| 条件完整 | if-then 规则有完整两部分 | Severe |

**错误模式**：
- 矛盾："总是 X" + "从不 X" → Fatal
- 不可能："必须 >10 且 <5" → Fatal
- 循环："A 需要 B，B 需要 A" → Fatal

### 合理性

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 可实现 | 规则在实践中可遵循 | Warning |
| 严重性相称 | 严重性与影响匹配 | Warning |
| 不过度约束 | 不做不必要的限制 | Warning |
| 不欠约束 | 提供充分指导 | Warning |
| 不与 AI 能力冗余 | 规则在 AI 能力之外有价值 | Info |

---

## 示例与规则一致性

> **关键**：与规则矛盾的示例会导致困惑和错误执行。

### 一致性维度

| 维度 | 检查 | 严重性 |
|------|------|--------|
| 格式 | 示例格式与规则匹配 | Severe |
| 值 | 示例值满足约束 | Severe |
| 术语 | 规则和示例使用相同术语 | Warning |
| 结构 | 示例结构遵循规则 | Severe |
| 时效性 | 示例使用当前模式，非已弃用的 | Warning |

### 常见不一致模式

| 模式 | 规则要求 | 示例展示 | 严重性 |
|------|----------|----------|--------|
| 命名不匹配 | "使用 kebab-case" | `my_file_name.md` | Severe |
| 约束违反 | "最多 3 项" | 展示 5 项 | Severe |
| 格式不匹配 | "输出为 JSON" | 纯文本 | Severe |
| 术语漂移 | "使用'agents'" | 使用"bots" | Warning |
| 弃用模式 | "使用 API v2" | 展示 API v1 | Warning |

### 不应标记

| 模式 | 原因 |
|------|------|
| 示例为清晰度简化 | 教学选择 |
| 示例展示"错误"模式（已标注）| 教授反模式 |
| 示例在不同上下文 | 适用不同规则 |

---

## 快速参考

### 严重性摘要

| 严重性 | 标准 |
|--------|------|
| Fatal | 执行不可能（矛盾、循环引用、不可能条件）|
| Severe | 重大影响（断裂引用、重复 ID、名称冲突、示例规则矛盾）|
| Warning | 质量影响（命名/顺序不一致、语义重复）|
| Info | 优化机会 |

### 证据输出格式

```
结构完整性: 文件 N/M 问题; 命名 K 冲突; 编号 L 断点/重复
引用: N 总计/M 断裂; 有效性: K 问题; 示例规则: P 不一致
```
