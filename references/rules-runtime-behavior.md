# 运行时行为审计规则

> **何时读取**：审计包含路由、阶段、命令、工具集成或执行流程的内容时。
> **适用性**：通用检查始终执行；条件检查仅在内容有相关特性时执行。

## 目录

- [通用检查](#通用检查)
- [条件检查](#条件检查)
- [常见模式](#常见模式)
- [快速参考](#快速参考)

---

## 通用检查

### 术语准确性

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 同一概念 = 同一术语 | 全程一个概念一个术语 | Warning |
| 术语匹配平台标准 | CLI/API/SDK 术语正确 | Severe |
| 技术词汇正确 | 术语在正确上下文使用 | Severe |
| 无误导性术语 | 术语准确描述功能 | Severe |

**常见问题**：
- 同义词混用：同一概念用"task/job/work" → 选定一个
- 角色混淆：交替使用"user/operator/caller" → 定义并一致使用
- 平台不匹配：CLI 命令用"endpoint" → 使用正确的领域术语

### 命名冲突检测

> **关键**：不同实体共享相同名称会导致困惑和执行歧义。

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 无名称冲突 | 不同实体 = 不同名称 | Severe |
| 标签名唯一 | 每个标签名 = 一个用途 | Severe |
| 无保留字遮蔽 | 自定义名称不遮蔽系统术语 | Warning |
| 跨作用域唯一 | 相关作用域内名称唯一 | Warning |

**常见冲突模式**：
- 标签冲突：两个不同的 `<output_spec>` 有不同用途
- 变量冲突：`{name}` 同时用于文件名和用户名
- 保留字遮蔽：自定义"Read"命令 vs 系统"Read"工具

### 冲突检测

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 无矛盾规则 | 规则不冲突 | Fatal |
| 无重叠路由 | 清晰边界或显式优先级 | Severe |
| 无无限循环 | 所有循环有退出条件 | Fatal |
| 无死胡同 | 所有路径到达结论 | Severe |
| 无循环引用 | 无 A→B→C→A 模式 | Fatal |

**缺陷模式**：

| 模式 | 严重性 |
|------|--------|
| 死代码（不可达路径）| Warning |
| 缺失处理器（未处理的情况）| Severe |
| 竞态条件（并发访问）| Severe |
| 逻辑错误（条件不正确）| Severe |
| 静默失败（错误未报告）| Warning |

---

## 条件检查

> **执行规则**：仅当内容有相关特性时执行每个章节。如特性不存在则跳过。

### 路由规则

> **条件**：内容有路由/分发逻辑（入口点表、输入→操作映射）

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 所有输入有路由 | 每种输入类型有处理器 | Severe |
| 默认路由存在 | 未匹配输入有回退 | Warning |
| 路由条件清晰 | 匹配标准无歧义 | Severe |
| 路由优先级已定义 | 重叠路由有优先顺序 | Severe |
| 无循环路由 | 无 A→B→C→A 路由循环 | Fatal |
| 路由目标存在 | 所有目标处理器存在 | Severe |

### 阶段/命令/工具检查

> **条件**：内容有多阶段工作流、CLI 命令或外部工具调用

这三种模式共享相同的审计结构：**触发器 → 流程 → 输出**

#### 触发器检查（适用于所有三者）

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 入口条件清晰 | 何时触发已定义 | Severe |
| 退出条件清晰 | 何时退出已定义 | Severe |
| 所有目标可达 | 入口路径存在 | Severe |
| 无孤立元素 | 每个元素有入口触发器 | Severe |
| 触发条件可测试 | 条件可评估 | Severe |

#### 流程检查（适用于所有三者）

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 主流程已记录 | 主要正常路径清晰 | Severe |
| 无无限循环 | 所有循环有退出条件 | Fatal |
| 无死胡同 | 所有分支到达结论 | Severe |
| 错误处理存在 | 异常路径已定义 | Warning |
| 流程顺序合理 | 步骤顺序正确 | Severe |

#### 输出格式检查（适用于所有三者）

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 格式已指定 | 输出格式已定义 | Severe |
| Schema 完整 | 必需字段已记录 | Severe |
| 跨元素一致 | 相关元素使用兼容格式 | Severe |
| Null 处理一致 | 缺失值统一处理 | Warning |
| i18n 合规 | 语言规则已遵循（如适用）| Warning |

#### 类型特定补充

**阶段特定**：
- 初始和终止阶段已定义
- 错误/恢复转换存在

**命令特定**：
- 参数/标志已指定
- Help 触发器存在
- 返回码已记录

**外部工具特定**：
- 工具可用性检查已定义
- 不可用时有回退
- 输入清理（缺失注入防护 = Fatal）
- 超时已定义

### 渐进加载

> **条件**：内容是技能、插件或有参考文件/脚本的分层结构

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 核心内容在 L1/L2 | 基本规则立即可用 | Severe |
| 详细内容在 L3 | 具体规则在参考文件中 | Warning |
| 模板引用而非嵌入 | 大型模板在单独文件中 | Warning |
| 脚本可调用 | 有效的调用语法 | Severe |
| 无循环加载 | 模块不循环 | Fatal |
| 加载失败已处理 | 缺失模块被捕获 | Warning |

---

## 常见模式

### 应该标记

| 问题 | 严重性 |
|------|--------|
| 无限循环（无退出条件）| Fatal |
| 循环引用/加载 | Fatal |
| 命令注入漏洞 | Fatal |
| 矛盾规则 | Fatal |
| 预期情况缺失处理器 | Severe |
| 断裂流程（死胡同）| Severe |
| 名称冲突导致歧义 | Severe |
| 术语不一致 | Warning |

### 不应标记

| 模式 | 原因 |
|------|------|
| 不太可能情况的可选错误处理 | 设计选择 |
| 缺少详细日志 | 优化，非缺陷 |
| 替代的有效方法 | 设计选择 |
| 平台特定模式 | 有意为之 |

---

## 快速参考

### 适用性矩阵

| 检查类别 | 执行时机 |
|----------|----------|
| 术语准确性 | 始终 |
| 命名冲突 | 始终 |
| 冲突检测 | 始终 |
| 路由规则 | 如有路由/分发逻辑 |
| 阶段检查 | 如有多阶段工作流 |
| 命令检查 | 如有 CLI/命令接口 |
| 外部工具检查 | 如有工具调用 |
| 渐进加载 | 如是有分层结构的技能/插件 |

### 严重性摘要

| 严重性 | 标准 |
|--------|------|
| Fatal | 执行不可能（无限循环、循环依赖、注入）|
| Severe | 重大影响（缺失处理器、断裂流程、歧义名称）|
| Warning | 质量影响（不一致、缺失文档）|
| Info | 优化机会 |

### 证据输出格式

```
运行时行为: 术语 OK/N 问题; 命名 M 冲突; 冲突 K 发现
[条件按适用]: 路由 N 条/M 问题; 阶段 N/M 问题; 命令 N/K 问题; 工具 N/L 问题; 加载 OK/问题
```
