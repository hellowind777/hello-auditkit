# Prompt 审计规则

> **继承**：`rules-universal.md` 中的所有规则
> **主要标准**：`ref-gpt-prompting-standard.md`（GPT-5.2 提示词指南）
> **执行要求**：执行以下每个检查表。输出每个类别的证据。
>
> **关键**：对于所有非脚本文本内容，应用 `ref-gpt-prompting-standard.md` 中的 GPT-5.2 提示词标准。

## 目录

- [概述](#概述)
- [审计执行](#审计执行)
- [预检查逻辑](#预检查逻辑)
- [自由度匹配](#自由度匹配)
- [LLM 提示词最佳实践](#llm-提示词最佳实践)
- [对话式/多阶段提示词规则](#对话式多阶段提示词规则)
- [网络搜索与研究规则](#网络搜索与研究规则)
- [API 参数参考](#api-参数参考)
- [长度与控制悖论](#长度与控制悖论)
- [应标记 / 不应标记](#应标记--不应标记)

---

## 概述

**适用于**：
- 独立的 LLM 提示词、系统提示词、指令文本
- **任意文本内容**（直接粘贴或来自任何文件，无论文件名是什么）
- 未识别内容类型的默认规则文件

**关键关注领域**（详见 `ref-gpt-prompting-standard.md`）：
- 详尽约束、范围纪律、结构化标签、反模式
- 停止条件、约束集中、禁止语言

> **动态验证**：审计前，按 SKILL.md 步骤 1 获取最新的 GPT 提示词指南。

---

## 审计执行

### 步骤 1：加载 GPT-5.2 标准

读取 `ref-gpt-prompting-standard.md` 并应用以下所有检查：
- 约束规范（详尽性、范围、停止、集中、禁止）
- 结构化标签块
- 反模式
- 多阶段规则（如适用）
- 工具使用规则（如适用）
- 长上下文处理（如 >10k token）
- 结构化输出（如是提取任务）

### 步骤 2：应用预检查逻辑

在标记任何"缺失"元素之前，验证意图是否已传达（见下文）。

### 步骤 3：应用类型特定检查

应用本文件中的检查：
- 自由度匹配
- 网络搜索与研究规则（如适用）
- API 参数（如适用）
- 长度与控制悖论（如比较版本）

### 步骤 4：生成发现

使用应标记/不应标记规则过滤问题。

---

## 预检查逻辑

> **关键**：在标记任何"缺失"元素之前，首先验证意图是否已传达。

<missing_element_analysis>
预检查逻辑的核心是判断"缺失"是否真的是问题：
- 演示性示例是否已暗示预期行为/格式？
- AI 能否从周围上下文推断预期行为？
- 没有显式约束，<30% 会误解吗？
仅当所有预检查的答案都是否时才标记为问题。
</missing_element_analysis>

| 检查 | 问题 | 如果是 → | 如果否 → |
|------|------|----------|----------|
| 演示性示例 | 内容是否有暗示预期行为/格式的示例？ | 不是问题（AI 能推断）| 继续规则检查 |
| 上下文清晰度 | AI 能从周围上下文推断预期行为吗？ | 不是问题（AI 能力）| 继续规则检查 |
| 阈值测试 | 没有显式约束 <30% 会误解吗？ | 不是问题（低于阈值）| 继续规则检查 |

**仅当所有预检查的答案都是否时才标记为问题。**

---

## 自由度匹配

> **Prompt 审计独有**：将约束级别与任务类型匹配。

<freedom_level_reasoning>
自由度匹配需要判断任务类型与约束级别的对应关系：
- 创意/灵活任务 → 高自由度，仅指南
- 代码生成 → 中自由度，模式 + 灵活性
- 数据提取 → 低自由度，严格模式
- 安全关键 → 极低自由度，显式脚本
- 对话式/多阶段 → 低自由度，强约束 + 显式门
</freedom_level_reasoning>

| 任务类型 | 自由度 | 约束风格 | 不匹配时的问题 |
|----------|--------|----------|----------------|
| 创意/灵活 | 高 | 仅指南 | 如果过度约束则 Warning |
| 代码生成 | 中 | 模式 + 灵活性 | 如果太刚性则 Warning |
| 数据提取 | 低 | 严格模式 | 如果无结构则 Severe |
| 安全关键 | 极低 | 显式脚本 | 如果太松则 Severe |
| 对话式/多阶段 | 低 | 强约束 + 显式门 | 如果规则分散或缺少门则 Severe |

---

## LLM 提示词最佳实践

> **完整详情**：见 `ref-gpt-prompting-standard.md`
> **适用于**：所有提示词/指令文本内容

### 核心实践摘要

| 实践 | 要求 | 缺失时严重性 |
|------|------|--------------|
| 详尽约束 | 明确限制："≤N 句/要点" | Severe |
| 范围边界 | "完全且仅限" + 明确的"禁止"列表 | Severe |
| 禁止捏造 | 事实任务有"禁止捏造..." | Severe |
| 输出模式 | 提取任务有 JSON/结构化格式 | Warning |
| 接地语言 | 不确定声明有"基于提供的上下文..." | Warning |
| 自检 | 高风险内容有验证步骤 | Warning |
| 工具偏好 | 获取新鲜数据时优先使用工具而非内部知识 | Warning |
| 代理式更新 | 简短（1-2 句），主要阶段，具体结果 | Warning |
| 长上下文处理 | >10k token 有大纲 + 约束重述 | Warning |

### 结构化标签块

| 标签类型 | 何时使用 | 缺失时严重性 |
|----------|----------|--------------|
| `<*_spec>` | 详尽性/格式约束 | Info |
| `<*_constraints>` | 范围边界 | Info |
| `<*_rules>` | 代理通信规则（代理式提示词）| Warning |
| `<*_schema>` | 输出模式（提取任务）| Warning |

---

## 对话式/多阶段提示词规则

> **适用于**：有多个阶段、状态机或对话流程的提示词
> **关键关注**：防止范围漂移和确保阶段门执行

### 约束放置

| 规则 | 要求 | 严重性 |
|------|------|--------|
| 约束在顶部 | 关键规则在提示词的前 20% | Severe |
| 集中化 | 规则在 ≤3 处（不分散）| Severe |
| 重述 | 每个阶段前重复关键约束 | Warning |

### 阶段门要求

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 显式停止条件 | 阶段边界有"停止并等待用户输入" | Severe |
| 强停止语言 | 使用"必须停止"、"禁止继续"（不是"应该停止"）| Severe |
| 门验证 | 推进前检查完成标准 | Warning |
| 无自动推进 | 未经用户确认绝不进入下一阶段 | Severe |

### 范围漂移预防

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 禁止语言强度 | 使用"禁止/MUST NOT/DO NOT"（不是"不要/don't/avoid"）| Warning |
| 范围重新锚定 | 每个阶段重述边界 | Warning |
| 任务扩展预防 | "禁止在请求之外添加/扩展/捏造" | Severe |

### 多阶段审计清单

| 检查 | 预期 | 严重性 |
|------|------|--------|
| 约束集中在顶部 | 是 | Severe |
| 每个门有强停止条件 | 是 | Severe |
| 禁止语言使用强形式 | 是 | Warning |
| 每个阶段有清晰的进入/退出标准 | 是 | Severe |
| 每个阶段重述范围边界 | 是 | Warning |

---

## 网络搜索与研究规则

> **来源**：GPT-5.2 提示词指南 - 综合网络研究代理规范
> **适用于**：涉及网络搜索、研究或信息收集的提示词

### 事实性要求（不可协商）

| 场景 | 要求 | 严重性 |
|------|------|--------|
| 时效性话题 | 必须浏览网络（新闻、价格、法律、产品规格）| Severe |
| 更新/小众话题 | 必须浏览（天气、汇率、标准）| Severe |
| 旅行/推荐 | 必须浏览获取当前信息 | Warning |
| 不确定的术语 | 必须浏览验证 | Warning |

### 引用要求

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 引用存在 | 每个包含网络来源声明的段落后需要 | Severe |
| 无捏造引用 | 禁止编造引用 | Severe |
| 多来源 | 关键声明使用多个来源 | Warning |

### 研究方法论

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 多次定向搜索 | 从多次搜索开始；可行时并行化 | Warning |
| 跟进搜索 | 添加定向跟进以填补空白 | Warning |
| 基于证据 | 如证据薄弱，继续搜索而非猜测 | Severe |

### 写作指南（研究输出）

| 检查 | 要求 | 严重性 |
|------|------|--------|
| 直接开始 | 立即开始回答，无前言 | Warning |
| 全面性 | 回答查询的每个部分 | Warning |
| 无后续问题 | 除非明确要求，禁止添加后续问题 | Warning |

---

## API 参数参考

> **注意**：当提示词包含参数建议时，与官方值核对验证。

| 参数 | 有效值 | 用途 |
|------|--------|------|
| reasoning_effort | none \| minimal \| low \| medium \| high \| xhigh | 控制思考深度 |
| verbosity | API 参数 | 控制最终答案长度 |

**GPT 5.2 迁移**：
- GPT-4o/4.1 → GPT-5.2：使用 `reasoning_effort: none`
- GPT-5/5.1 → GPT-5.2：保持相同的 effort 值

**响应压缩**（GPT 5.2）：对于长代理式工作流，使用 `/responses/compact` 端点。

---

## 长度与控制悖论

> **关键洞察**：更长的提示词 ≠ 更好的控制。通常恰恰相反。

| 症状 | 可能原因 | 修复优先级 |
|------|----------|------------|
| 更长版本执行更弱 | 移除了集中规则，添加了分散内容 | 恢复集中块 |
| 更详细但合规性更低 | 用解释稀释了关键约束 | 删除解释，保留约束 |
| 添加了示例但失去控制 | 示例无约束 | 添加约束，不只是示例 |

**审计执行**：
1. 如审计"v2"或"更新"版本，与原版比较（如有）
2. 检查关键约束块是否被移除或稀释
3. 如约束被分散 → 标记为"约束稀释"（Severe）

---

## 应标记 / 不应标记

### 应标记

> **预检查**：标记前，验证问题是否能通过 AI 推断解决。

| 问题 | 严重性 | 预检查 |
|------|--------|--------|
| 矛盾指令 | Fatal | 始终标记 |
| 不可能的约束 | Fatal | 始终标记 |
| 缺少关键上下文 | Fatal | 始终标记 |
| 无详尽指导且无演示性示例 | Severe | 仅当 AI 无法推断时 |
| 无范围指示且无上下文边界 | Severe | 仅当 AI 无法推断时 |
| 无"禁止"约束且范围模糊 | Severe | 仅当 AI 无法推断时 |
| 结构化任务的输出格式模糊 | Severe | 检查示例是否展示格式 |
| 允许捏造（无接地）| Severe | 事实任务始终标记 |
| 模糊指令（"做好它"）| Warning | 检查示例是否澄清 |
| 高风险内容无自检 | Warning | - |

### 不应标记

| 模式 | 原因 |
|------|------|
| 简单提示词无约束 | 简单任务不需要 |
| 风格偏好 | 设计选择 |
| 缺少可选元素 | 可选的 |
| **无显式约束但有演示性示例** | AI 能从示例推断 |
| **无显式规则但上下文明确暗示行为** | AI 能力 |
| **原始设计通过结构/示例传达意图** | 添加显式规则是冗余的 |

---

## 审计清单

> **完整清单**：见 `ref-gpt-prompting-standard.md` → 审计清单

### 附加检查（本文件）

- [ ] 自由度与任务类型匹配
- [ ] 应用网络搜索规则（如是研究任务）
- [ ] API 参数有效（如已指定）
- [ ] 无约束稀释（如比较版本）
- [ ] 标记前应用预检查逻辑
